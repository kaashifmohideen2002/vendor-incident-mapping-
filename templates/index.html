<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Device Incident Analyzer - SOC Dashboard</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Date Range Picker CSS -->
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --success-color: #27ae60;
      --warning-color: #f39c12;
      --danger-color: #e74c3c;
      --bg-light: #ecf0f1;
      --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-success: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
      --gradient-info: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
      --shadow-light: 0 2px 10px rgba(0,0,0,0.08);
      --shadow-medium: 0 4px 20px rgba(0,0,0,0.12);
      --shadow-heavy: 0 8px 30px rgba(0,0,0,0.16);
    }

    body { 
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-weight: 400;
      line-height: 1.6;
    }

    .navbar { 
      background: var(--gradient-primary);
      box-shadow: var(--shadow-medium);
      backdrop-filter: blur(10px);
    }
    .navbar-brand { font-weight: 700; font-size: 1.5rem; letter-spacing: -0.5px; }

    .stat-card { 
      border-radius: 16px; 
      border: none; 
      box-shadow: var(--shadow-light);
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      position: relative;
      overflow: hidden;
    }
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0.7) 50%, rgba(255,255,255,0.3) 100%);
    }
    .stat-card:hover { 
      transform: translateY(-8px) scale(1.02);
      box-shadow: var(--shadow-heavy);
    }
    .stat-icon { font-size: 2.8rem; opacity: 0.9; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }

    .client-card { 
      cursor: pointer; 
      border-radius: 12px; 
      border: 2px solid transparent;
      background: white;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      box-shadow: var(--shadow-light);
    }
    .client-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: 12px;
      background: linear-gradient(135deg, transparent, rgba(52, 152, 219, 0.05));
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .client-card:hover { 
      border-color: var(--secondary-color); 
      box-shadow: var(--shadow-medium);
      transform: translateY(-3px);
    }
    .client-card:hover::before { opacity: 1; }
    .client-card.selected { 
      border-color: var(--secondary-color); 
      background: linear-gradient(135deg, rgba(52, 152, 219, 0.08), rgba(52, 152, 219, 0.02));
      box-shadow: var(--shadow-medium);
    }

    .table-container { 
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px; 
      padding: 24px; 
      box-shadow: var(--shadow-light);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .severity-badge { 
      padding: 6px 14px; 
      border-radius: 20px; 
      font-size: 0.8rem; 
      font-weight: 600;
      border: 1px solid transparent;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .severity-high { 
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      color: white;
      box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
    }
    .severity-medium { 
      background: linear-gradient(135deg, #feca57, #ff9ff3);
      color: white;
      box-shadow: 0 2px 8px rgba(254, 202, 87, 0.3);
    }
    .severity-low { 
      background: linear-gradient(135deg, #48dbfb, #0abde3);
      color: white;
      box-shadow: 0 2px 8px rgba(72, 219, 251, 0.3);
    }

    .loading-spinner { display: none; text-align: center; padding: 50px; }
    .section-title { 
      font-size: 1.6rem; 
      font-weight: 700; 
      color: var(--primary-color); 
      margin-bottom: 24px; 
      padding-bottom: 12px; 
      border-bottom: 3px solid transparent;
      background: linear-gradient(90deg, var(--secondary-color), transparent) bottom / 100% 3px no-repeat;
      letter-spacing: -0.5px;
    }

    .chart-container { 
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px; 
      padding: 24px; 
      box-shadow: var(--shadow-light);
      margin-bottom: 24px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .btn-export { 
      background: var(--gradient-success);
      border: none; 
      color: white; 
      padding: 12px 28px; 
      border-radius: 12px; 
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 15px rgba(76, 217, 100, 0.3);
      letter-spacing: 0.3px;
    }
    .btn-export:hover { 
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(76, 217, 100, 0.4);
      color: white;
    }

    .device-name-cell { max-width: 280px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .empty-state { 
      text-align: center; 
      padding: 80px 20px; 
      color: #6c757d;
    }
    .empty-state i { 
      font-size: 5rem; 
      opacity: 0.3; 
      margin-bottom: 24px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .vendor-badge { 
      padding: 6px 12px; 
      border-radius: 8px; 
      font-size: 0.8rem; 
      font-weight: 600;
      background: var(--gradient-info);
      color: white;
      border: none;
      box-shadow: 0 2px 6px rgba(116, 185, 255, 0.3);
    }
    .model-badge { 
      padding: 6px 12px; 
      border-radius: 8px; 
      font-size: 0.8rem; 
      font-weight: 600;
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      color: #2d3436;
      box-shadow: 0 2px 6px rgba(168, 237, 234, 0.3);
    }
    .vendor-loading { 
      color: #6c757d; 
      font-style: italic; 
      font-size: 0.85rem;
      animation: pulse 1.5s infinite;
    }
    .vendor-unknown { color: #adb5bd; font-style: italic; }

    .export-options { display: flex; gap: 12px; flex-wrap: wrap; }
    #vendorLoadingIndicator { display: none; margin-left: 12px; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .table-hover tbody tr:hover {
      background-color: rgba(52, 152, 219, 0.04);
      transform: translateX(2px);
      transition: all 0.2s ease;
    }

    .btn {
      border-radius: 10px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
    }

    /* Enhanced Alert Styles */
    .alert {
      border: none;
      border-radius: 12px;
      padding: 16px 20px;
      box-shadow: var(--shadow-light);
    }

    .alert-info {
      background: linear-gradient(135deg, rgba(116, 185, 255, 0.1), rgba(116, 185, 255, 0.05));
      border-left: 4px solid #74b9ff;
    }

    .alert-success {
      background: linear-gradient(135deg, rgba(39, 174, 96, 0.1), rgba(39, 174, 96, 0.05));
      border-left: 4px solid #27ae60;
    }

    .alert-warning {
      background: linear-gradient(135deg, rgba(243, 156, 18, 0.1), rgba(243, 156, 18, 0.05));
      border-left: 4px solid #f39c12;
    }

    .alert-danger {
      background: linear-gradient(135deg, rgba(231, 76, 60, 0.1), rgba(231, 76, 60, 0.05));
      border-left: 4px solid #e74c3c;
    }

    /* Calendar Date Picker Styles */
    .daterangepicker {
      border-radius: 12px !important;
      box-shadow: 0 8px 30px rgba(0,0,0,0.16) !important;
      border: none !important;
    }
    .daterangepicker .calendar-table th, 
    .daterangepicker .calendar-table td {
      border-radius: 8px;
    }
    .daterangepicker td.active, 
    .daterangepicker td.active:hover {
      background: var(--secondary-color) !important;
    }
    .daterangepicker .ranges li.active {
      background: var(--secondary-color) !important;
    }
    .date-picker-input {
      background: linear-gradient(135deg, rgba(52, 152, 219, 0.08), rgba(52, 152, 219, 0.02));
      border: 2px solid rgba(52, 152, 219, 0.2);
      border-radius: 10px;
      padding: 10px 16px;
      transition: all 0.3s ease;
    }
    .date-picker-input:focus {
      border-color: var(--secondary-color);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
      outline: none;
    }
  </style>
</head>

<body>
<nav class="navbar navbar-dark mb-4">
  <div class="container-fluid">
    <a class="navbar-brand" href="#"><i class="bi bi-shield-check"></i> Device Incident Analyzer</a>
    <span class="navbar-text text-white"><i class="bi bi-building"></i> SOC Dashboard</span>
  </div>
</nav>

<div class="container-fluid">
  <!-- Date Range Filter Controls -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="card">
        <div class="card-body py-3">
          <div class="row align-items-center">
            <div class="col-md-6">
              <div class="d-flex align-items-center">
                <label class="form-label mb-0 me-3 fw-medium">
                  <i class="bi bi-calendar-range"></i> Database Date Range:
                </label>
                <input type="text" class="form-control date-picker-input" id="dateRange" 
                       placeholder="Select date range..." readonly style="max-width: 280px; cursor: pointer;">
              </div>
            </div>
            <div class="col-md-6">
              <div class="d-flex align-items-center gap-2">
                <button class="btn btn-outline-primary btn-sm" id="applyDateRange">
                  <i class="bi bi-check-circle"></i> Apply Range
                </button>
                <button class="btn btn-outline-secondary btn-sm" id="resetToLast24h">
                  <i class="bi bi-arrow-clockwise"></i> Last 24h
                </button>
                <div class="alert alert-info mb-0 py-2 flex-grow-1">
                  <small>
                    <i class="bi bi-info-circle"></i> 
                    <strong>Note:</strong> SIEM vendor lookups remain fixed at 24 hours for optimal performance.
                  </small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="row mb-4" id="dashboardStats">
    <div class="col-md-3 mb-3">
      <div class="card stat-card bg-primary text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-subtitle mb-2 opacity-75">Total Clients</h6>
              <h2 class="card-title mb-0" id="totalClients">-</h2>
            </div>
            <i class="bi bi-building-fill stat-icon"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3 mb-3">
      <div class="card stat-card bg-info text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-subtitle mb-2 opacity-75">Total Devices</h6>
              <h2 class="card-title mb-0" id="totalDevices">-</h2>
            </div>
            <i class="bi bi-hdd-network-fill stat-icon"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3 mb-3">
      <div class="card stat-card bg-warning text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-subtitle mb-2 opacity-75">Total Incidents</h6>
              <h2 class="card-title mb-0" id="totalIncidents">-</h2>
            </div>
            <i class="bi bi-exclamation-triangle-fill stat-icon"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3 mb-3">
      <div class="card stat-card bg-danger text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-subtitle mb-2 opacity-75">High Severity</h6>
              <h2 class="card-title mb-0" id="highSeverity">-</h2>
            </div>
            <i class="bi bi-shield-fill-exclamation stat-icon"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-4 mb-4">
      <div class="section-title"><i class="bi bi-list-ul"></i> Select Client</div>

      <div class="mb-3">
        <input type="text" class="form-control" id="searchClient" placeholder="üîç Search clients...">
      </div>

      <div id="clientList" style="max-height: 600px; overflow-y: auto;">
        <div class="loading-spinner" style="display: block;">
          <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
          <p class="mt-2">Loading clients...</p>
        </div>
      </div>
    </div>

    <div class="col-md-8 mb-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="section-title mb-0">
          <i class="bi bi-hdd-network"></i> Device Incident Analysis
          <span id="vendorLoadingIndicator">
            <span class="spinner-border spinner-border-sm text-primary" role="status"></span>
            <small class="text-muted">Loading vendor info...</small>
          </span>
        </div>

        <div class="export-options" style="display:none;" id="exportOptions">
          <div class="dropdown">
            <button class="btn btn-export dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-download"></i> Export to CSV
            </button>
            <ul class="dropdown-menu" aria-labelledby="exportDropdown">
              <li><a class="dropdown-item" href="#" id="exportBasic"><i class="bi bi-file-earmark-text"></i> Basic Export</a></li>
              <li><a class="dropdown-item" href="#" id="exportWithVendor">
                <i class="bi bi-file-earmark-plus"></i> Export with Vendor Info
                <small class="text-muted d-block">Includes FortiSIEM data</small>
              </a></li>
            </ul>
          </div>

          <button class="btn btn-outline-success btn-sm" id="vendorIncidentsBtn" title="View Vendor Incidents Report">
            <i class="bi bi-building"></i> Vendor Incidents
          </button>

          <button class="btn btn-outline-primary btn-sm" id="refreshVendorBtn" title="Refresh Vendor Info">
            <i class="bi bi-arrow-clockwise"></i> Refresh Vendors
          </button>
        </div>
      </div>

      <div id="clientSummary" style="display:none;">
        <div class="row mb-3">
          <div class="col-md-3">
            <div class="card text-center"><div class="card-body">
              <h3 class="text-primary" id="summaryDevices">0</h3><small class="text-muted">Devices</small>
            </div></div>
          </div>
          <div class="col-md-3">
            <div class="card text-center"><div class="card-body">
              <h3 class="text-warning" id="summaryIncidents">0</h3><small class="text-muted">Incidents</small>
            </div></div>
          </div>
          <div class="col-md-3">
            <div class="card text-center"><div class="card-body">
              <h3 class="text-success" id="summaryActiveDays">0</h3><small class="text-muted">Active Days</small>
            </div></div>
          </div>
          <div class="col-md-3">
            <div class="card text-center"><div class="card-body">
              <h3 class="text-info" id="summaryAvgIncidents">0</h3><small class="text-muted">Avg/Device</small>
            </div></div>
          </div>
        </div>

        <div class="chart-container mb-3">
          <canvas id="severityChart" height="80"></canvas>
        </div>
      </div>

      <div class="table-container">
        <div id="deviceTableContainer">
          <div class="empty-state">
            <i class="bi bi-inbox"></i>
            <h4>No Client Selected</h4>
            <p>Select a client from the list to view device incident analysis</p>
          </div>
        </div>

        <div id="deviceLoadingSpinner" class="loading-spinner">
          <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
          <p class="mt-2">Loading device data...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<!-- Date Range Picker JS -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

<script>
  let selectedClientId = null;
  let selectedClientName = null;
  let fortisiemCustId = null;
  let deviceTable = null;
  let severityChart = null;
  let deviceVendors = {}; // bulk cache
  let currentDateRange = {
    start: moment().subtract(24, 'hours'),
    end: moment()
  };

  function loadDashboardStats() {
    const hours = calculateHoursFromDateRange();
    fetch(`/api/dashboard/stats?hours=${hours}`)
      .then(r => r.json())
      .then(data => {
        $('#totalClients').text(data.total_clients || 0);
        $('#totalDevices').text(data.total_devices || 0);
        $('#totalIncidents').text(data.total_incidents || 0);
        $('#highSeverity').text(data.high_severity_count || 0);
      })
      .catch(err => console.error('Error loading dashboard stats:', err));
  }

  function calculateHoursFromDateRange() {
    const diffInHours = currentDateRange.end.diff(currentDateRange.start, 'hours');
    return Math.max(1, diffInHours); // Minimum 1 hour
  }

  function loadClients() {
    fetch('/api/clients')
      .then(r => r.json())
      .then(clients => {
        const clientList = $('#clientList');
        clientList.empty();

        if (!clients || clients.length === 0) {
          clientList.html('<div class="empty-state"><p>No clients found</p></div>');
          return;
        }

        clients.forEach(client => {
          const statusBadge = client.status === 1 ?
            '<span class="badge bg-success">Active</span>' :
            '<span class="badge bg-secondary">Inactive</span>';

          const card = $(`
            <div class="card client-card mb-2" data-client-id="${client.id}" data-client-name="${client.name}">
              <div class="card-body py-2">
                <div class="d-flex justify-content-between align-items-center">
                  <div><h6 class="mb-0">${client.name}</h6></div>
                  ${statusBadge}
                </div>
              </div>
            </div>
          `);

          card.on('click', function() {
            selectClient(client.id, client.name);
          });

          clientList.append(card);
        });
      })
      .catch(err => {
        console.error('Error loading clients:', err);
        $('#clientList').html('<div class="alert alert-danger">Error loading clients</div>');
      });
  }

  function selectClient(clientId, clientName) {
    selectedClientId = clientId;
    selectedClientName = clientName;
    deviceVendors = {};

    $('.client-card').removeClass('selected');
    $(`.client-card[data-client-id="${clientId}"]`).addClass('selected');

    loadClientSummary(clientId);
    loadDeviceData(clientId);

    $('#exportOptions').show();
  }

  function loadClientSummary(clientId) {
    const hours = calculateHoursFromDateRange();
    fetch(`/api/client/${clientId}/summary?hours=${hours}`)
      .then(r => r.json())
      .then(data => {
        $('#clientSummary').show();
        $('#summaryDevices').text(data.total_devices || 0);
        $('#summaryIncidents').text(data.total_incidents || 0);
        $('#summaryActiveDays').text(data.active_days || 0);

        const avgIncidents = (data.total_devices > 0) ? (data.total_incidents / data.total_devices).toFixed(1) : 0;
        $('#summaryAvgIncidents').text(avgIncidents);

        updateSeverityChart(data);
      })
      .catch(err => console.error('Error loading client summary:', err));
  }

  function updateSeverityChart(data) {
    const ctx = document.getElementById('severityChart').getContext('2d');
    if (severityChart) severityChart.destroy();

    severityChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['High', 'Medium', 'Low'],
        datasets: [{
          label: 'Incidents by Severity',
          data: [data.high_severity || 0, data.medium_severity || 0, data.low_severity || 0],
          backgroundColor: ['rgba(231, 76, 60, 0.8)','rgba(243, 156, 18, 0.8)','rgba(39, 174, 96, 0.8)'],
          borderColor: ['rgba(231, 76, 60, 1)','rgba(243, 156, 18, 1)','rgba(39, 174, 96, 1)'],
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { display: false },
          title: { display: true, text: 'Incident Distribution by Severity' }
        },
        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
      }
    });
  }

  function loadDeviceData(clientId) {
    $('#deviceTableContainer').hide();
    $('#deviceLoadingSpinner').show();

    const hours = calculateHoursFromDateRange();
    fetch(`/api/client/${clientId}/devices/with-vendor?hours=${hours}`)
      .then(r => r.json())
      .then(data => {
        $('#deviceLoadingSpinner').hide();
        $('#deviceTableContainer').show();

        const devices = data.devices || [];
        fortisiemCustId = data.fortisiem_cust_id;

        if (!devices.length) {
          $('#deviceTableContainer').html(`
            <div class="empty-state">
              <i class="bi bi-inbox"></i>
              <h4>No Devices Found</h4>
              <p>No incident data available for this client</p>
            </div>
          `);
          return;
        }

        if (deviceTable) deviceTable.destroy();

        let tableHtml = `
          <table id="deviceTable" class="table table-striped table-hover">
            <thead>
              <tr>
                <th>#</th>
                <th>Device Name</th>
                <th>Vendor</th>
                <th>Model</th>
                <th>Incidents</th>
                <th>High</th>
                <th>Medium</th>
                <th>Low</th>
                <th>First Seen</th>
                <th>Last Seen</th>
              </tr>
            </thead>
            <tbody>
        `;

        devices.forEach((device, index) => {
          const deviceNameEscaped = (device.device_name || '').replace(/"/g, '&quot;');
          tableHtml += `
            <tr data-device-name="${deviceNameEscaped}">
              <td>${index + 1}</td>
              <td class="device-name-cell" title="${device.device_name}">${device.device_name}</td>
              <td class="vendor-cell">
                <span class="vendor-loading"><i class="bi bi-arrow-clockwise"></i> Loading vendor...</span>
                <br><small><a href="#" onclick="openVendorLive('${deviceNameEscaped}');return false;" class="text-decoration-none">
                  <i class="bi bi-play-circle"></i> Live Query
                </a></small>
              </td>
              <td class="model-cell"><span class="vendor-loading"><i class="bi bi-arrow-clockwise"></i> Loading model...</span></td>
              <td><span class="badge bg-primary rounded-pill">${device.incident_count}</span></td>
              <td><span class="severity-badge severity-high">${device.high_severity || 0}</span></td>
              <td><span class="severity-badge severity-medium">${device.medium_severity || 0}</span></td>
              <td><span class="severity-badge severity-low">${device.low_severity || 0}</span></td>
              <td><small class="text-muted">${device.first_incident || 'N/A'}</small></td>
              <td><small class="text-muted">${device.last_incident || 'N/A'}</small></td>
            </tr>
          `;
        });

        tableHtml += `</tbody></table>`;
        $('#deviceTableContainer').html(tableHtml);

        deviceTable = $('#deviceTable').DataTable({
          pageLength: 25,
          order: [[4, 'desc']],
          language: { search: "Search devices:", lengthMenu: "Show _MENU_ devices per page" }
        });

        loadVendorInfo(clientId);
      })
      .catch(err => {
        console.error('Error loading device data:', err);
        $('#deviceLoadingSpinner').hide();
        $('#deviceTableContainer').html(`
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i> Error loading device data
          </div>
        `).show();
      });
  }

  function loadVendorInfo(clientId) {
    $('#vendorLoadingIndicator').show();
    
    // Load vendor info and existing selections in parallel
    const hours = calculateHoursFromDateRange();
    Promise.all([
      fetch(`/api/client/${clientId}/devices/vendors?hours=${hours}`).then(r => r.json()),
      fetch(`/api/device/vendor/selections?client_id=${clientId}`).then(r => r.json())
    ])
      .then(([vendorData, selectionsData]) => {
        $('#vendorLoadingIndicator').hide();
        if (!vendorData.vendors) return;

        deviceVendors = vendorData.vendors;
        const selections = selectionsData.selections || [];
        const selectionMap = {};
        
        // Create map of existing selections
        selections.forEach(selection => {
          selectionMap[selection.device_name] = selection;
        });

        $('#deviceTable tbody tr').each(function() {
          const deviceName = $(this).data('device-name');
          const vendorInfo = deviceVendors[deviceName];
          const existingSelection = selectionMap[deviceName];

          if (!vendorInfo) {
            const vendorCell = $(this).find('.vendor-cell');
            const liveLink = vendorCell.find('small').parent().html();
            vendorCell.html(`<span class="vendor-unknown">N/A</span> <small><a href="#" onclick="showManualVendorEntry('${escapeHtml(deviceName)}'); return false;" class="text-primary text-decoration-none"><i class="bi bi-pencil-square"></i> Set Manually</a></small><br>${liveLink}`);
            $(this).find('.model-cell').html('<span class="vendor-unknown">N/A</span>');
            return;
          }

          const vendorCell = $(this).find('.vendor-cell');
          const modelCell = $(this).find('.model-cell');

          // Check if user has made a selection
          if (existingSelection) {
            const selectedVendor = existingSelection.selected_vendor;
            const selectedModel = existingSelection.selected_model;
            
            // Determine if this was a manual selection (if vendor doesn't match any SIEM results)
            const isManual = !vendorInfo || vendorInfo.vendor === 'Unknown' || 
              !vendorInfo.vendors.some(v => v.vendor === selectedVendor && v.model === selectedModel);
            
            const badge = isManual ? 
              '<small class="badge bg-info rounded-pill"><i class="bi bi-pencil-square"></i> Manual</small>' :
              '<small class="badge bg-success rounded-pill"><i class="bi bi-check-circle"></i> Selected</small>';
            
            // keep live link (second line)
            const liveLink = vendorCell.find('small').parent().html();
            vendorCell.html(`<span class="vendor-badge">${escapeHtml(selectedVendor)}</span> ${badge}<br>${liveLink}`);
            modelCell.html(`<span class="model-badge">${escapeHtml(selectedModel)}</span>`);
            modelCell.off('click').css('cursor', 'default').removeAttr('title');
          } else {
            // No selection made, show primary vendor with option to select if multiple
            const primaryVendor = vendorInfo.vendor || 'Unknown';
            const primaryModel = vendorInfo.model || 'Unknown';
            const isAutoSaved = vendorInfo.auto_saved === true;
            const isSingleResult = vendorInfo.single_result === true;

            // preserve the Live link we already placed; rebuild only the top part
            let vendorTop = '';
            if (primaryVendor !== 'Unknown' && primaryVendor !== 'Error') {
              vendorTop = `<span class="vendor-badge">${escapeHtml(primaryVendor)}</span>`;
              
              // Show different badges based on result type
              if (isAutoSaved) {
                vendorTop += ` <small class="badge bg-info rounded-pill"><i class="bi bi-robot"></i> Auto-Selected</small>`;
                // Show notification for auto-save
                setTimeout(() => {
                  showAlert('info', `‚ú® Auto-selected vendor for ${deviceName}: ${primaryVendor} / ${primaryModel}`, 4000);
                }, 1000);
              } else if (isSingleResult) {
                vendorTop += ` <small class="badge bg-success rounded-pill"><i class="bi bi-check-circle"></i> Single Match</small>`;
              } else if (vendorInfo.total_entries > 1) {
                vendorTop += ` <small class="badge bg-warning rounded-pill"><i class="bi bi-exclamation-triangle"></i> ${vendorInfo.total_entries} options - Click to choose</small>`;
              }
            } else {
              vendorTop = `<span class="vendor-unknown">${escapeHtml(primaryVendor)}</span> <small><a href="#" onclick="showManualVendorEntry('${escapeHtml(deviceName)}'); return false;" class="text-primary text-decoration-none"><i class="bi bi-pencil-square"></i> Set Manually</a></small>`;
            }

            // keep live link (second line)
            const liveLink = vendorCell.find('small').parent().html();
            vendorCell.html(vendorTop + '<br>' + liveLink);

            if (primaryModel !== 'Unknown' && primaryModel !== 'Error') {
              let modelHtml = `<span class="model-badge">${escapeHtml(primaryModel)}</span>`;
              
              // Add click handler for multiple results only
              if (vendorInfo.total_entries > 1) {
                modelHtml += ` <small class="text-primary">üëÜ Click to choose</small>`;
                modelCell.html(modelHtml);
                modelCell.css('cursor', 'pointer').attr('title', 'Click to select correct vendor from multiple options');
                modelCell.off('click').on('click', function() {
                  showVendorDetails(deviceName, vendorInfo);
                });
              } else {
                modelCell.html(modelHtml);
                modelCell.off('click').css('cursor', 'default').removeAttr('title');
              }
            } else {
              modelCell.html(`<span class="vendor-unknown">${escapeHtml(primaryModel)}</span>`);
            }
          }
        });
      })
      .catch(err => {
        console.error('Error loading vendor info:', err);
        $('#vendorLoadingIndicator').hide();
        $('#deviceTable tbody tr').each(function() {
          $(this).find('.vendor-cell').prepend('<span class="text-danger">Error</span><br>');
          $(this).find('.model-cell').html('<span class="text-danger">Error</span>');
        });
      });
  }

  function showVendorDetails(deviceName, vendorInfo) {
    if (!vendorInfo.vendors || !vendorInfo.vendors.length) {
      showAlert('warning', 'No vendor information available for this device.');
      return;
    }

    let modalHtml = `
      <div class="modal fade" id="vendorDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title">
                <i class="bi bi-building-check"></i> Select Correct Vendor for Device
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="alert alert-light border-primary">
                <div class="d-flex align-items-center">
                  <i class="bi bi-hdd-network-fill text-primary fs-4 me-3"></i>
                  <div>
                    <strong class="text-primary">Device:</strong> ${escapeHtml(deviceName)}<br>
                    <small class="text-muted">Found ${vendorInfo.total_entries} vendor/model combination(s)</small>
                  </div>
                </div>
              </div>
              
              <p class="fw-semibold mb-3">
                <i class="bi bi-hand-index"></i> Please select the correct vendor that best represents this device:
              </p>
              
              <div class="vendor-selection-container">
    `;

    vendorInfo.vendors.forEach((v, idx) => {
      const isRecommended = idx === 0;
      const cardClass = isRecommended ? 'border-success bg-success bg-opacity-10' : 'border-secondary';
      const badge = isRecommended ? '<span class="badge bg-success ms-2"><i class="bi bi-star"></i> Recommended</span>' : '';
      
      modalHtml += `
        <div class="card mb-3 vendor-option-card ${cardClass}" style="cursor: pointer;" 
             onclick="selectVendorOption('${escapeHtml(deviceName)}', '${escapeHtml(v.vendor)}', '${escapeHtml(v.model)}', this)">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-1">
                <input type="radio" name="vendorSelection" value="${idx}" class="form-check-input form-check-input-lg">
              </div>
              <div class="col-4">
                <div class="d-flex align-items-center">
                  <i class="bi bi-building-fill text-primary me-2"></i>
                  <div>
                    <strong class="vendor-name">${escapeHtml(v.vendor)}</strong>
                    ${badge}
                  </div>
                </div>
              </div>
              <div class="col-4">
                <div class="d-flex align-items-center">
                  <i class="bi bi-cpu text-secondary me-2"></i>
                  <span class="model-name text-dark">${escapeHtml(v.model)}</span>
                </div>
              </div>
              <div class="col-3 text-end">
                <div class="d-flex align-items-center justify-content-end">
                  <i class="bi bi-graph-up text-info me-2"></i>
                  <span class="badge bg-info fs-6">${v.count} events</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    });

    modalHtml += `
              </div>
              
              <div class="alert alert-info mt-4">
                <i class="bi bi-lightbulb"></i> <strong>Helpful Tips:</strong>
                <ul class="mb-0 mt-2">
                  <li>The recommended option (‚≠ê) has the most events and is likely correct</li>
                  <li>Your selection will be saved and used for incident reporting</li>
                  <li>You can change your selection later if needed</li>
                </ul>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                <i class="bi bi-x-circle"></i> Cancel
              </button>
              <button type="button" class="btn btn-success" id="confirmVendorSelection" disabled>
                <i class="bi bi-check-circle"></i> Confirm Selection
              </button>
            </div>
          </div>
        </div>
      </div>
    `;

    $('#vendorDetailsModal').remove();
    $('body').append(modalHtml);
    
    // Add CSS for hover effects
    $('head').append(`
      <style>
        .vendor-option-card:hover {
          border-color: var(--bs-primary) !important;
          box-shadow: 0 4px 12px rgba(52, 152, 219, 0.15);
          transform: translateY(-2px);
          transition: all 0.2s ease;
        }
        .vendor-option-card.selected {
          border-color: var(--bs-success) !important;
          background-color: rgba(40, 167, 69, 0.1) !important;
          box-shadow: 0 4px 12px rgba(40, 167, 69, 0.2);
        }
        .vendor-selection-container {
          max-height: 400px;
          overflow-y: auto;
        }
      </style>
    `);
    
    new bootstrap.Modal(document.getElementById('vendorDetailsModal')).show();
  }

  function selectVendorOption(deviceName, vendor, model, cardElement) {
    // Clear previous selections
    $('#vendorDetailsModal .vendor-option-card').removeClass('selected');
    $('#vendorDetailsModal input[type="radio"]').prop('checked', false);
    
    // Select current card
    $(cardElement).addClass('selected');
    $(cardElement).find('input[type="radio"]').prop('checked', true);
    
    // Enable confirm button with animation
    const confirmBtn = $('#confirmVendorSelection');
    confirmBtn.prop('disabled', false);
    confirmBtn.removeClass('btn-outline-success').addClass('btn-success');
    
    // Store selection data
    confirmBtn.data('selection', {
      deviceName: deviceName,
      vendor: vendor,
      model: model
    });
    
    // Add a subtle success animation
    $(cardElement).addClass('animate__animated animate__pulse');
    setTimeout(() => {
      $(cardElement).removeClass('animate__animated animate__pulse');
    }, 600);
  }

  // Handle vendor selection confirmation
  $(document).on('click', '#confirmVendorSelection', function() {
    const selection = $(this).data('selection');
    if (!selection) return;
    
    const btn = $(this);
    const originalText = btn.html();
    btn.html('<i class="bi bi-hourglass-split"></i> Saving...').prop('disabled', true);
    
    // Save vendor selection
    fetch('/api/device/vendor/select', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        device_name: selection.deviceName,
        client_id: selectedClientId,
        vendor: selection.vendor,
        model: selection.model
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        // Close modal
        $('#vendorDetailsModal').modal('hide');
        
        // Update the device table to show selected vendor
        updateDeviceRowVendor(selection.deviceName, selection.vendor, selection.model);
        
        // Show success message
        showAlert('success', `Vendor selection saved: ${selection.vendor} / ${selection.model}`);
      } else {
        showAlert('danger', `Error saving vendor selection: ${data.error || 'Unknown error'}`);
      }
    })
    .catch(error => {
      console.error('Error saving vendor selection:', error);
      showAlert('danger', 'Error saving vendor selection. Please try again.');
    })
    .finally(() => {
      btn.html(originalText).prop('disabled', false);
    });
  });

  function updateDeviceRowVendor(deviceName, vendor, model, isManual = false) {
    $('#deviceTable tbody tr').each(function() {
      if ($(this).data('device-name') === deviceName) {
        const vendorCell = $(this).find('.vendor-cell');
        const modelCell = $(this).find('.model-cell');
        
        // Keep the Live link
        const liveLink = vendorCell.find('small').parent().html();
        const liveLinkPart = liveLink.split('<br>')[1] || '';
        
        const badge = isManual ? 
          '<small class="badge bg-info rounded-pill"><i class="bi bi-pencil-square"></i> Manual</small>' :
          '<small class="badge bg-success rounded-pill"><i class="bi bi-check-circle"></i> Selected</small>';
        
        vendorCell.html(`<span class="vendor-badge">${escapeHtml(vendor)}</span> ${badge}<br>${liveLinkPart}`);
        modelCell.html(`<span class="model-badge">${escapeHtml(model)}</span>`);
        modelCell.off('click').css('cursor', 'default').removeAttr('title');
      }
    });
  }

  function showAlert(type, message, duration = 5000) {
    const alertId = 'alert-' + Date.now();
    const alert = $(`
      <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert" style="margin-bottom: 1rem; border-radius: 12px;">
        <div class="d-flex align-items-center">
          <i class="bi ${getAlertIcon(type)} me-2"></i>
          <div>${message}</div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    `);
    
    // Add alert to notifications container or create one
    let notificationsContainer = $('#notifications-container');
    if (notificationsContainer.length === 0) {
      notificationsContainer = $('<div id="notifications-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px;"></div>');
      $('body').append(notificationsContainer);
    }
    
    notificationsContainer.append(alert);
    
    // Auto-dismiss after specified duration
    setTimeout(() => {
      alert.fadeOut(300, function() {
        $(this).remove();
      });
    }, duration);
  }
  
  function getAlertIcon(type) {
    switch(type) {
      case 'success': return 'bi-check-circle-fill';
      case 'info': return 'bi-info-circle-fill';
      case 'warning': return 'bi-exclamation-triangle-fill';
      case 'danger': return 'bi-x-circle-fill';
      default: return 'bi-info-circle-fill';
    }
  }

  function getTimeRangeText(hours) {
    if (hours <= 1) return 'Last 1 Hour';
    if (hours <= 6) return `Last ${hours} Hours`;
    if (hours <= 24) return `Last ${hours} Hours`;
    if (hours <= 48) return `Last ${Math.ceil(hours/24)} Day(s)`;
    return `Last ${Math.ceil(hours/24)} Days`;
  }

  function showVendorIncidentsReport() {
    if (!selectedClientId) return;
    
    const btn = $('#vendorIncidentsBtn');
    const originalText = btn.html();
    btn.html('<i class="bi bi-hourglass-split"></i> Loading...').prop('disabled', true);
    
    // Get current time filter in hours
    const hours = Math.ceil(currentDateRange.end.diff(currentDateRange.start, 'hours', true));
    
    fetch(`/api/vendor/incidents/summary?client_id=${selectedClientId}&hours=${hours}`)
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          showAlert('danger', `Error loading vendor incidents: ${data.error}`);
          return;
        }
        
        displayVendorIncidentsModal(data, hours);
      })
      .catch(error => {
        console.error('Error loading vendor incidents:', error);
        showAlert('danger', 'Error loading vendor incidents report. Please try again.');
      })
      .finally(() => {
        btn.html(originalText).prop('disabled', false);
      });
  }

  function displayVendorIncidentsModal(data, hours) {
    const timeRangeText = getTimeRangeText(hours);
    let modalHtml = `
      <div class="modal fade" id="vendorIncidentsModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <div>
                <h5 class="modal-title">
                  <i class="bi bi-building"></i> Vendor Incidents Report - ${escapeHtml(selectedClientName)}
                </h5>
                <small class="text-muted">Time Range: ${timeRangeText}</small>
              </div>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
    `;
    
    if (data.summary_lines && data.summary_lines.length > 0) {
      modalHtml += `
        <div class="alert alert-info">
          <h6><i class="bi bi-info-circle"></i> Summary</h6>
          <ul class="mb-0">
      `;
      data.summary_lines.forEach(line => {
        modalHtml += `<li>${escapeHtml(line)}</li>`;
      });
      modalHtml += `</ul></div>`;
    }
    
    if (data.model_summary && data.model_summary.length > 0) {
      modalHtml += `
        <h6 class="mt-3"><i class="bi bi-cpu-fill"></i> Model Breakdown</h6>
        <div class="accordion" id="modelAccordion">
      `;
      
      data.model_summary.forEach((model, idx) => {
        modalHtml += `
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button ${idx > 0 ? 'collapsed' : ''}" type="button" 
                      data-bs-toggle="collapse" data-bs-target="#model${idx}">
                <div class="d-flex w-100 justify-content-between align-items-center me-3">
                  <div class="d-flex align-items-center gap-3">
                    <span><strong>${escapeHtml(model.model)}</strong></span>
                    <span class="badge bg-secondary vendor-indicator">${escapeHtml(model.vendor)}</span>
                  </div>
                  <div class="d-flex gap-2">
                    <span class="badge bg-primary">${model.total_incidents} incidents</span>
                    <span class="badge bg-dark">${model.true_incidents || 0} true incidents</span>
                    <span class="badge bg-info">${model.device_count} devices</span>
                    <span class="badge bg-danger">${model.high_severity} high</span>
                    <span class="badge bg-warning">${model.medium_severity} medium</span>
                    <span class="badge bg-success">${model.low_severity} low</span>
                  </div>
                </div>
              </button>
            </h2>
            <div id="model${idx}" class="accordion-collapse collapse ${idx === 0 ? 'show' : ''}" data-bs-parent="#modelAccordion">
              <div class="accordion-body">
                <h6>Devices:</h6>
                <div class="table-responsive">
                  <table class="table table-sm table-striped">
                    <thead><tr><th>Device Name</th><th>Incidents</th><th>True</th><th>High</th><th>Med</th><th>Low</th><th>First Seen</th><th>Last Seen</th></tr></thead>
                    <tbody>
        `;
        
        model.devices.forEach(device => {
          modalHtml += `
            <tr>
              <td class="device-name-cell" title="${escapeHtml(device.device_name)}">${escapeHtml(device.device_name)}</td>
              <td><span class="badge bg-primary">${device.incident_count}</span></td>
              <td><span class="badge bg-dark">${device.true_incident_count || 0}</span></td>
              <td><span class="severity-badge severity-high">${device.high_severity}</span></td>
              <td><span class="severity-badge severity-medium">${device.medium_severity}</span></td>
              <td><span class="severity-badge severity-low">${device.low_severity}</span></td>
              <td>${device.first_incident || 'N/A'}</td>
              <td>${device.last_incident || 'N/A'}</td>
            </tr>
          `;
        });
        
        modalHtml += `
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        `;
      });
      modalHtml += `</div>`;
    }
    
    if (data.unselected_devices && data.unselected_devices.length > 0) {
      modalHtml += `
        <div class="alert alert-warning mt-4">
          <h6><i class="bi bi-exclamation-triangle"></i> Devices Without Vendor Selection (${data.total_unselected_devices})</h6>
          <p class="mb-2">These devices have incidents but no vendor has been selected yet:</p>
          <div class="table-responsive">
            <table class="table table-sm table-striped">
              <thead><tr><th>Device Name</th><th>Incidents</th><th>High</th><th>Med</th><th>Low</th><th>Action</th></tr></thead>
              <tbody>
      `;
      
      data.unselected_devices.forEach(device => {
        modalHtml += `
          <tr>
            <td class="device-name-cell" title="${escapeHtml(device.device_name)}">${escapeHtml(device.device_name)}</td>
            <td><span class="badge bg-primary">${device.incident_count}</span></td>
            <td><span class="severity-badge severity-high">${device.high_severity}</span></td>
            <td><span class="severity-badge severity-medium">${device.medium_severity}</span></td>
            <td><span class="severity-badge severity-low">${device.low_severity}</span></td>
            <td>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" onclick="selectVendorForDevice('${escapeHtml(device.device_name)}')">
                  <i class="bi bi-list-ul"></i> Choose
                </button>
                <button class="btn btn-outline-info" onclick="showManualVendorEntry('${escapeHtml(device.device_name)}')">
                  <i class="bi bi-pencil-square"></i> Manual
                </button>
              </div>
            </td>
          </tr>
        `;
      });
      
      modalHtml += `
              </tbody>
            </table>
          </div>
        </div>
      `;
    }
    
    if (!data.model_summary || data.model_summary.length === 0) {
      modalHtml += `
        <div class="empty-state">
          <i class="bi bi-cpu"></i>
          <h4>No Model Data Available</h4>
          <p>No vendor selections have been made yet. Select vendors for devices to see incident reports.</p>
        </div>
      `;
    }
    
    modalHtml += `
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    $('#vendorIncidentsModal').remove();
    $('body').append(modalHtml);
    new bootstrap.Modal(document.getElementById('vendorIncidentsModal')).show();
  }

  function selectVendorForDevice(deviceName) {
    // Close incidents modal first
    $('#vendorIncidentsModal').modal('hide');
    
    // Find the device in the current vendor data and show selection modal
    const vendorInfo = deviceVendors[deviceName];
    if (vendorInfo && vendorInfo.total_entries > 1) {
      showVendorDetails(deviceName, vendorInfo);
    } else {
      showAlert('info', 'Please load vendor information for this device first by viewing the device table.');
    }
  }

  function showManualVendorEntry(deviceName) {
    let modalHtml = `
      <div class="modal fade" id="manualVendorModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title">
                <i class="bi bi-pencil-square"></i> Manually Set Vendor Information
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="alert alert-light border-primary">
                <div class="d-flex align-items-center">
                  <i class="bi bi-hdd-network-fill text-primary fs-4 me-3"></i>
                  <div>
                    <strong class="text-primary">Device:</strong> ${escapeHtml(deviceName)}<br>
                    <small class="text-muted">Set vendor and model information manually</small>
                  </div>
                </div>
              </div>
              
              <form id="manualVendorForm">
                <div class="mb-3">
                  <label for="vendorInput" class="form-label">
                    <i class="bi bi-building"></i> Vendor Name <span class="text-danger">*</span>
                  </label>
                  <input type="text" class="form-control" id="vendorInput" placeholder="Enter vendor name (e.g., Microsoft, Cisco, HP)" required>
                  <div class="form-text">Enter the manufacturer or vendor of this device</div>
                </div>
                
                <div class="mb-3">
                  <label for="modelInput" class="form-label">
                    <i class="bi bi-cpu"></i> Model Name
                  </label>
                  <input type="text" class="form-control" id="modelInput" placeholder="Enter model name (optional)">
                  <div class="form-text">Enter the specific model or leave blank if unknown</div>
                </div>
                
                <div class="alert alert-info">
                  <i class="bi bi-lightbulb"></i> <strong>Tips:</strong>
                  <ul class="mb-0 mt-2">
                    <li>Use standard vendor names (Microsoft, Cisco, Dell, HP, etc.)</li>
                    <li>Model field is optional - you can leave it blank or enter "Unknown"</li>
                    <li>This information will be saved and used for reporting</li>
                  </ul>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                <i class="bi bi-x-circle"></i> Cancel
              </button>
              <button type="submit" form="manualVendorForm" class="btn btn-primary" id="saveManualVendor">
                <i class="bi bi-check-circle"></i> Save Vendor Info
              </button>
            </div>
          </div>
        </div>
      </div>
    `;

    $('#manualVendorModal').remove();
    $('body').append(modalHtml);
    
    const modal = new bootstrap.Modal(document.getElementById('manualVendorModal'));
    modal.show();
    
    // Focus on vendor input when modal opens
    $('#manualVendorModal').on('shown.bs.modal', function() {
      $('#vendorInput').focus();
    });
    
    // Handle form submission
    $('#manualVendorForm').on('submit', function(e) {
      e.preventDefault();
      
      const vendor = $('#vendorInput').val().trim();
      const model = $('#modelInput').val().trim() || 'Unknown';
      
      if (!vendor) {
        showAlert('warning', 'Please enter a vendor name.');
        $('#vendorInput').focus();
        return;
      }
      
      const btn = $('#saveManualVendor');
      const originalText = btn.html();
      btn.html('<i class="bi bi-hourglass-split"></i> Saving...').prop('disabled', true);
      
      // Save manual vendor selection
      fetch('/api/device/vendor/manual', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          device_name: deviceName,
          client_id: selectedClientId,
          vendor: vendor,
          model: model
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          // Close modal
          modal.hide();
          
          // Update the device table to show manual vendor
          updateDeviceRowVendor(deviceName, data.vendor, data.model, true);
          
          // Show success message
          showAlert('success', `Manual vendor information saved: ${data.vendor} / ${data.model}`);
        } else {
          showAlert('danger', `Error saving vendor information: ${data.error || 'Unknown error'}`);
        }
      })
      .catch(error => {
        console.error('Error saving manual vendor:', error);
        showAlert('danger', 'Error saving vendor information. Please try again.');
      })
      .finally(() => {
        btn.html(originalText).prop('disabled', false);
      });
    });
  }

  // NEW: live XML + progress + result via SSE
  function openVendorLive(deviceName) {
    if (!fortisiemCustId) {
      alert("FortiSIEM customer ID not available yet.");
      return;
    }

    $('#vendorLiveModal').remove();

    const modalHtml = `
      <div class="modal fade" id="vendorLiveModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Live Vendor Lookup: ${escapeHtml(deviceName)}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-2">
                <div class="progress">
                  <div id="liveProgressBar" class="progress-bar" role="progressbar" style="width:0%">0%</div>
                </div>
                <small class="text-muted" id="liveMeta"></small>
              </div>

              <div class="accordion" id="liveAccordion">
                <div class="accordion-item">
                  <h2 class="accordion-header">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#liveXml">
                      XML Query
                    </button>
                  </h2>
                  <div id="liveXml" class="accordion-collapse collapse show" data-bs-parent="#liveAccordion">
                    <div class="accordion-body">
                      <pre id="liveXmlPre" class="bg-light p-3" style="font-size:.8rem;overflow:auto;"></pre>
                    </div>
                  </div>
                </div>

                <div class="accordion-item">
                  <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#liveResult">
                      Parsed Result
                    </button>
                  </h2>
                  <div id="liveResult" class="accordion-collapse collapse" data-bs-parent="#liveAccordion">
                    <div class="accordion-body">
                      <div id="liveResultBox" class="table-responsive"></div>
                    </div>
                  </div>
                </div>

                <div class="accordion-item">
                  <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#liveRawXml">
                      Raw Result XML
                    </button>
                  </h2>
                  <div id="liveRawXml" class="accordion-collapse collapse" data-bs-parent="#liveAccordion">
                    <div class="accordion-body">
                      <pre id="liveRawXmlPre" class="bg-light p-3" style="font-size:.8rem;max-height:400px;overflow:auto;"></pre>
                    </div>
                  </div>
                </div>
              </div>

              <div class="mt-2 text-danger" id="liveError"></div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
    `;

    $('body').append(modalHtml);
    const modalEl = document.getElementById('vendorLiveModal');
    const modal = new bootstrap.Modal(modalEl);
    modal.show();

    const url = `/api/device/vendor/stream?device_name=${encodeURIComponent(deviceName)}&cust_id=${encodeURIComponent(fortisiemCustId)}`;
    const es = new EventSource(url);

    modalEl.addEventListener('hidden.bs.modal', () => {
      try { es.close(); } catch(e) {}
    });

    es.addEventListener("xml", (ev) => {
      const data = JSON.parse(ev.data);
      $('#liveXmlPre').text(data.xml_query || '');
    });

    es.addEventListener("meta", (ev) => {
      const data = JSON.parse(ev.data);
      $('#liveMeta').text(`requestId=${data.request_id}, expireTime=${data.expire_time}`);
    });

    es.addEventListener("progress", (ev) => {
      const data = JSON.parse(ev.data);
      const p = Math.max(0, Math.min(100, data.progress || 0));
      $('#liveProgressBar').css('width', `${p}%`).text(`${p}%`);
    });

    es.addEventListener("result", (ev) => {
      const data = JSON.parse(ev.data);

      let html = `<table class="table table-striped">
        <thead><tr><th>Vendor</th><th>Model</th><th>Count</th></tr></thead><tbody>`;
      (data.vendors || []).forEach(v => {
        html += `<tr><td>${escapeHtml(v.vendor)}</td><td>${escapeHtml(v.model)}</td><td>${v.count}</td></tr>`;
      });
      html += `</tbody></table>`;
      $('#liveResultBox').html(html);

      $('#liveRawXmlPre').text(data.raw_xml || '');

      // open parsed section
      new bootstrap.Collapse(document.getElementById('liveResult'), {toggle: true});
    });

    es.addEventListener("error", (ev) => {
      // EventSource fires error on disconnect too; handle only if payload is present
      try {
        const data = JSON.parse(ev.data || '{}');
        if (data.message) $('#liveError').text(data.message);
      } catch(e) {}
    });

    es.addEventListener("done", () => {
      try { es.close(); } catch(e) {}
      $('#liveProgressBar').css('width', `100%`).text(`100%`);
    });
  }

  // helper
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text == null ? '' : String(text);
    return div.innerHTML;
  }

  // export actions
  $('#exportBasic').on('click', function(e) {
    e.preventDefault();
    if (selectedClientId) {
      const hours = calculateHoursFromDateRange();
      window.location.href = `/api/client/${selectedClientId}/export?hours=${hours}`;
    }
  });

  $('#exportWithVendor').on('click', function(e) {
    e.preventDefault();
    if (!selectedClientId) return;

    const btn = $(this);
    const originalHtml = btn.html();
    btn.html('<i class="bi bi-hourglass-split"></i> Preparing export...');
    btn.addClass('disabled');

    setTimeout(() => {
      const hours = calculateHoursFromDateRange();
      window.location.href = `/api/client/${selectedClientId}/export?include_vendor=true&hours=${hours}`;
      setTimeout(() => {
        btn.html(originalHtml);
        btn.removeClass('disabled');
      }, 3000);
    }, 100);
  });

  $('#refreshVendorBtn').on('click', function() {
    if (!selectedClientId) return;
    fetch('/api/cache/clear')
      .then(() => loadVendorInfo(selectedClientId))
      .catch(() => loadVendorInfo(selectedClientId));
  });

  $('#vendorIncidentsBtn').on('click', function() {
    if (!selectedClientId) return;
    showVendorIncidentsReport();
  });

  $('#searchClient').on('keyup', function() {
    const searchTerm = $(this).val().toLowerCase();
    $('.client-card').each(function() {
      const clientName = ($(this).data('client-name') || '').toLowerCase();
      $(this).toggle(clientName.includes(searchTerm));
    });
  });

  // Initialize Date Range Picker
  function initializeDateRangePicker() {
    $('#dateRange').daterangepicker({
      startDate: currentDateRange.start,
      endDate: currentDateRange.end,
      timePicker: true,
      timePicker24Hour: true,
      timePickerIncrement: 15,
      locale: {
        format: 'MM/DD/YYYY HH:mm'
      },
      ranges: {
        'Last 1 Hour': [moment().subtract(1, 'hours'), moment()],
        'Last 6 Hours': [moment().subtract(6, 'hours'), moment()],
        'Last 12 Hours': [moment().subtract(12, 'hours'), moment()],
        'Last 24 Hours': [moment().subtract(24, 'hours'), moment()],
        'Last 2 Days': [moment().subtract(2, 'days'), moment()],
        'Last 3 Days': [moment().subtract(3, 'days'), moment()],
        'Last 7 Days': [moment().subtract(7, 'days'), moment()],
        'Last 30 Days': [moment().subtract(30, 'days'), moment()]
      },
      alwaysShowCalendars: true,
      showDropdowns: true,
      autoApply: false
    }, function(start, end, label) {
      currentDateRange.start = start;
      currentDateRange.end = end;
      
      // Update display
      $('#dateRange').val(start.format('MM/DD/YYYY HH:mm') + ' - ' + end.format('MM/DD/YYYY HH:mm'));
      
      // Show friendly label if it's a preset range
      if (label && label !== 'Custom Range') {
        showAlert('info', `Date range updated: ${label}`, 2000);
      }
      
      // Auto-refresh vendor incidents modal if it's open (for preset ranges only)
      if (label && label !== 'Custom Range') {
        const vendorModal = document.getElementById('vendorIncidentsModal');
        if (vendorModal && $(vendorModal).hasClass('show')) {
          setTimeout(() => {
            showVendorIncidentsReport();
          }, 500); // Small delay to let the alert show
        }
      }
    });

    // Set initial display
    $('#dateRange').val(currentDateRange.start.format('MM/DD/YYYY HH:mm') + ' - ' + currentDateRange.end.format('MM/DD/YYYY HH:mm'));
  }

  // Apply date range button handler
  $('#applyDateRange').on('click', function() {
    const btn = $(this);
    const originalHtml = btn.html();
    btn.html('<i class="bi bi-hourglass-split"></i> Applying...').prop('disabled', true);
    
    // Reload all data with new date range
    loadDashboardStats();
    
    const selectedClientId = $('.client-card.selected').data('client-id');
    if (selectedClientId) {
      loadClientSummary(selectedClientId);
      loadDeviceData(selectedClientId);
      
      // Refresh vendor incidents modal if it's open
      const vendorModal = document.getElementById('vendorIncidentsModal');
      if (vendorModal && $(vendorModal).hasClass('show')) {
        showVendorIncidentsReport();
      }
    }
    
    showAlert('success', `Applied date range: ${currentDateRange.start.format('MM/DD HH:mm')} - ${currentDateRange.end.format('MM/DD HH:mm')}`, 3000);
    
    setTimeout(() => {
      btn.html(originalHtml).prop('disabled', false);
    }, 1000);
  });

  // Reset to last 24 hours button handler
  $('#resetToLast24h').on('click', function() {
    currentDateRange = {
      start: moment().subtract(24, 'hours'),
      end: moment()
    };
    
    // Update picker
    $('#dateRange').data('daterangepicker').setStartDate(currentDateRange.start);
    $('#dateRange').data('daterangepicker').setEndDate(currentDateRange.end);
    $('#dateRange').val(currentDateRange.start.format('MM/DD/YYYY HH:mm') + ' - ' + currentDateRange.end.format('MM/DD/YYYY HH:mm'));
    
    showAlert('info', 'Reset to last 24 hours', 2000);
  });

  $(document).ready(function() {
    initializeDateRangePicker();
    loadDashboardStats();
    loadClients();
  });
</script>

</body>
</html>
